Dockerfile

A text document that contains all the commands a user
could call on the command line to assemble an image

Build context
A folder on local system containing source code / GitHub URL / etc.
Specific files can be ignored with ".dockerignore"


- - - Node.js example - - -

FROM ubuntu  # base image

RUN apt update && apt install nodejs npm -y # add new layer

COPY . .  # copy required files (application)

RUN npm install  # add new layer

CMD ["npm", "run", "dev"]  # execute when running container from image (only 1 CMD instruction allowed)


To build the image:
docker build -t api-node:2 .  # -t to add tag, . to specify current folder

Improvements for smaller, faster, more secure image:

Use images with runtime already installed, using smaller base linux (FROM node / FROM node:19.6-alpine)
Use separate layer for dependencies so cache is not invalidated (COPY package*.json ./ before npm install)
Specify working directory where dependencies and files are loaded (WORKDIR /usr/src/app for nodejs)
Use .dockerignore file to specify files not to be copied / Specify the actual files to be copied (COPY ./src .)
Optimize CMD instruction (CMD ["node", "index.js"])
Run commands inside container as non-root (USER node) -> (COPY --chown=node:node ./src .)
Set environment variables according to environment (ENV NODE_ENV production)
Do clean, repeatable install with npm (RUN npm ci --only=production)
Document expected port, it doesn't change the container (EXPOSE 3000)

If DOCKER_BUILDKIT=1 is enabled, this will only download new dependencies for npm, old will be cached
RUN --mount=type=cache,target=/usr/src/app/.npm \
  npm set cache /usr/src/app/.npm && \
  npm ci --only=production


- - - Full golang example with improvements - - -

# Pin specific version for stability
# Use separate stage for building image
# Use debian for easier build utilities
FROM golang:1.19-bullseye AS build-base

WORKDIR /app 

# Copy only files required to install dependencies (better layer caching)
COPY go.mod go.sum ./

# Use cache mount to speed up install of existing dependencies
RUN --mount=type=cache,target=/go/pkg/mod \
  --mount=type=cache,target=/root/.cache/go-build \
  go mod download

FROM build-base AS dev

# Install air for hot reload & delve for debugging
RUN go install github.com/cosmtrek/air@v1.43.0 && \
  go install github.com/go-delve/delve/cmd/dlv@v1.20.2

COPY . .

CMD ["air", "-c", ".air.toml"]

FROM build-base AS build-production

# Add non root user
RUN useradd -u 1001 nonroot

COPY . .

# Compile healthcheck
RUN go build \
  -ldflags="-linkmode external -extldflags -static" \
  -tags netgo \
  -o healthcheck \
  ./healthcheck/healthcheck.go

# Compile application during build rather than at runtime
# Add flags to statically link binary
RUN go build \
  -ldflags="-linkmode external -extldflags -static" \
  -tags netgo \
  -o api-golang

# Use separate stage for deployable image
FROM scratch

# Set gin mode
ENV GIN_MODE=release

WORKDIR /

# Copy the passwd file
COPY --from=build-production /etc/passwd /etc/passwd

# Copy the healthcheck binary from the build stage
COPY --from=build-production /app/healthcheck/healthcheck healthcheck

# Copy the app binary from the build stage
COPY --from=build-production /app/api-golang api-golang

# Use nonroot user
USER nonroot

# Indicate expected port
EXPOSE 8080

CMD ["/api-golang"]


- - - Nginx example for react client - - -

# syntax=docker/dockerfile:1.5

FROM node:19.4-bullseye AS build

# Specify working directory other than /
WORKDIR /usr/src/app

# Copy only files required to install
# dependencies (better layer caching)
COPY package*.json ./

# Use cache mount to speed up install of existing dependencies
RUN --mount=type=cache,target=/usr/src/app/.npm \
  npm set cache /usr/src/app/.npm && \
  npm install

COPY . .

RUN npm run build

# Use separate stage for deployable image
FROM nginxinc/nginx-unprivileged:1.23-alpine-perl

# Use COPY --link to avoid breaking cache if we change the second stage base image
COPY --link nginx.conf /etc/nginx/conf.d/default.conf

COPY --link --from=build usr/src/app/dist/ /usr/share/nginx/html

EXPOSE 8080


- - - General principles - - -

Pin specific image versions
Use small & secure base images
Protect layer cache
Be explicit (working path, expose, environment variables)
Avoid unneeded files, specify needed files
Install only prod dependencies, leverage multi-stage builds


- - - Additional features
Parser directives (which dockerfile version, escape character, etc.)
ARGs (can be overridden at build time)
LABEL (add extra key-value info, like author e-mail)
Heredocs syntax (Run multiple commands treated as one line)
Mounting secrets (use files during build that won't be included in the container)
Entrypoint (arguments can be passed for commands running at runtime)
ADD exists (similar to COPY but slightly different)
buildx (can be used for multi-architecture images)